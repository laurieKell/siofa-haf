---
title: "SIOFA Sharks"
subtitle: "SIOFA Data"
author: "DELEGATION OF THE EUROPEAN UNION"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

## Introduction

This document reads in and provides a summary of the shark dataset provided by SIOFA. This includes information on shark captures such as species, length, weight, sex, maturity, and other relevant data. The aim is to understand the diversity of species, the types of data collected, and assess the quality and coverage of the dataset.

```{r, knitr, eval=TRUE, echo=FALSE, warning=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(knitr)
opts_chunk$set(cache     =TRUE, 
               comment   =NA, 
               warning   =FALSE, 
               message   =FALSE, 
               error     =FALSE, 
               echo      =FALSE, 
               eval      =TRUE,
               cache     =TRUE,
               cache.path=  "cache/data_siofa/",
               fig.path  ="../figs/data_siofa/",
               fig.width =12,
               fig.height=8,
               dev       ="png")
iFig=0
iTab=0
```

```{r lib, include=FALSE}
library(openxlsx)  # For reading Excel files
library(lubridate) # For handling date and time
library(plyr)      # For data manipulation
library(dplyr)     # For data manipulation
library(reshape)   # For data manipulation
library(ggplot2)   # For plotting
library(ggpubr)    # For plotting
library(mapdata)   # For map-based data
library(viridis)   # For color scales, better for visibility

library(FLCore)
library(ggplotFL)
```

```{r, setwd, eval=FALSE}
setwd("/home/laurie/Desktop/active/sofia-haf/Rmd")
```

## Dataset Overview
```{r, data}
load("../data/inputs/Sharks_biological.Rdata")
biol=as.data.frame(biol)
names(biol)[c(3,5,6,7,12)]=c("len","mass","sex","mat","species")

load("../data/inputs/Sharks_logbooks.Rdata")
cpue=as.data.frame(cpue)

biol=merge(biol,cpue[,c("cod_set","month","year","Area")],by=c("cod_set"))
names(biol)=tolower(names(biol))

mat=setNames(seq(4),c("A","B","C","D"))
biol$mat[biol$mat%in%names(mat)]=mat[biol$mat[biol$mat%in%names(mat)]]
biol$mat=substr(biol$mat,nchar(biol$mat),1)

# Function to convert species names into abbreviated factor
sppAbbrv<-function(spp) {
  # Split the genus and species names
  names=strsplit(spp, " ")
  
  abbrv=sapply(names, function(name) {
    paste0(substr(name[1], 1, 1), ". ", name[2])})}

biol=transform(biol,spp=factor(sppAbbrv(species)))
biol=transform(biol,mature=ifelse(as.numeric(mat)>=3,1,0))

save(biol,file="../data/biolIEO.RData")
```

### Length data
```{r}
load("../data/biolIEO.RData")

# Number of observations per category
nobs=ddply(biol,.(spp), with, data.frame(n=length(len)))
biol=left_join(biol, nobs, by="spp")

ggplot(biol, aes(len)) +
  geom_histogram(bins=50, fill="skyblue", color="blue") +
  facet_wrap(~spp, scales="free_y", ncol=3) +
  #scale_y_continuous(breaks=function(x) {c(0,round(max(x,na.rm=TRUE)))})+  
  geom_text(data=nobs, aes(label=paste("n =", n), x=Inf, y=Inf), 
            position = position_nudge(x=-0.5, y=-0.5), hjust=1, vjust=1)+
  xlab("Length (cm)")+ylab("")+ 
  theme(legend.position = "bottom", 
                    axis.title.y = element_blank(), 
                    axis.text.y  = element_blank(), 
                    axis.ticks.y = element_blank())
```


```{r}
load("../data/lh.RData")

dat=subset(biol,n>150&year>2018&sex%in%c("M","F"))
dat=dat[grep("spp",dat$spp,invert=TRUE),]

load("/home/laurie/Desktop/active/sofia-haf/data/lh.RData")
lh=transform(lh,spp=paste(substr(Genus,1,1),". ",Species,sep=""))

sexRatio=ddply(dat, .(spp,year), with, data.frame(M=sum(sex=="M"),F=sum(sex=="F")))
sexRatio=transform(sexRatio,ratio=F/(M+F))

gghistogram(dat,x="len",fill="sex",position="stack",bins=50)+
  facet_grid(spp~year,scale="free_y")+
  geom_vline(aes(xintercept=exp(Loo)),
             data=subset(lh,spp%in%unique(dat$spp)),col="blue")+
  geom_vline(aes(xintercept=exp(Lm)), data=subset(lh,spp%in%unique(dat$spp)),col="red")+
  #scale_y_continuous(breaks=function(x) {round(max(x, na.rm=TRUE))})+
  theme(legend.position = "bottom", 
                    axis.title.y = element_blank(), 
                    axis.text.y  = element_blank(), 
                    axis.ticks.y = element_blank())+
  xlab("Length (cm)")+
  geom_text(data=sexRatio,aes(label=round(ratio,2), x=Inf, y=Inf), 
            position = position_nudge(x=-0.5, y=-0.5), hjust=1, vjust=1)
```

```{r}
flens=ddply(biol,.(spp,year,month,len), with,data.frame(data=length(cod_set)))
flens=FLQuants(dlply(flens,.(spp), with, 
              as.FLQuant(data.frame(data=data,len=as.numeric(len),year=year,season=month))))
flens=FLQuants(llply(flens, function(x){
    x[is.na(x)]=0
    x}))
  
plotLengths(flens[[1]])
```


## Maturity 

### Females
1: immature; 2: maturing; 3: mature; 4: uterine developing; 5: differentiating; 6: expecting; 7: post-natal, spent; 8: Re-starting development

### Males
1: immature; 2: developing; 3: mature; 4: active


```{r, mat}
mat =subset(biol,!is.na(mature))
nobs=ddply(mat,.(spp),     with, data.frame(n =length(mature)))
nob2=ddply(mat,.(spp,sex), with, data.frame(n2=length(mature)))
mat =merge(merge(mat,nobs),nob2)

ggplot(subset(mat,sex=="F"))+
  #geom_text(data=nobs, aes(label=paste("n =", n), x=Inf, y=Inf), 
  #          position = position_nudge(x=-0.5, y=-0.5), hjust=1, vjust=1)+
  geom_histogram(aes(len,fill=ac(mature)),position='fill')+
  facet_wrap(~spp)

ggplot(subset(mat,sex=="M"))+
  geom_text(data=nobs, aes(label=paste("n =", n), x=Inf, y=Inf), 
            position = position_nudge(x=-0.5, y=-0.5), hjust=1, vjust=1)+
  geom_histogram(aes(len,fill=ac(mature)),position='fill')+
  facet_wrap(~spp)
```




```{r}
model=glm(mature~len+sex+len:sex+len:Type, data=biol, family=binomial)
mat$hat=predict(model,type="response")

```

#### Fit logistic regression model
```{r, mat-fit}
model=glm(mature~len+sex+len:sex+len:Type, data=mat, family=binomial)
mat$hat=predict(model,type="response")

ggplot(mat, aes(x=len, y=hat, color=sex, linetype=Type)) + 
  geom_line() + 
  labs(x = "Length", y = "Predicted Maturity Probability") + 
  scale_y_continuous(limits = c(0, 1)) + 
  theme_minimal()
```

#### Diagnostics focusing on checks for model fit, influential observations, and assumption violations:

### 1. Summary of Model Fit
- Use `summary(model)` to get an overview of the model fit, including coefficients, standard errors, z-values, and P-values for each predictor.

```{r}
summary(model)  
```

### 2. Residuals and Model Fit
- **Residuals Plot**: Plot residuals to look for patterns. For logistic regression, deviance residuals can be informative.

```{r}
mat$rsdl=residuals(model, type = "deviance")

ggplot(mat)+
  geom_point(aes(len,rsdl))+
  facet_grid(sex~Type)
```
- **Hosmer-Lemeshow Test**: Test for goodness of fit specifically designed for logistic regression.
```{r}
library(ResourceSelection)
hoslem.test(model$y, fitted(model))
```

### 3. Influence Measures
- **Cook's Distance**: Identify influential observations based on Cook's distance.

### 3. Influence Measures
- **Cook's Distance**: Identify influential observations based on Cook's distance.
```{r, eval=TRUE, echo=FALSE}
mat$cdist=cooks.distance(model)

ggplot(mat) +
  geom_linerange(aes(len,ymin=0,ymax=cdist))+
  labs(title = "Influence Plot Using Cook's Distance",
       x = "Length (cm)",
       y = "Cook's Distance") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_grid(sex~Type)
```

- **Leverage and Influence Plots**: Identify observations with high leverage or influence on the model estimation.
```{r}
library(car)
influencePlot(model, id.method="identify", main="Influence Plot", sub="Circle size is proportional to Cook's Distance")
```

To create an influence plot using `ggplot2` that mimics the functionality of the `car::influencePlot`, you'll need to manually calculate the elements you want to visualize: leverage, standardized residuals, and Cook's distance. Here's how you can do it with a logistic regression model as an example. This approach involves extracting the necessary statistics from the model and then plotting them using `ggplot2`.

First, ensure you have your logistic regression model fitted. For this example, let's assume your model is stored in a variable named `model`. You'll need the `broom` and `ggplot2` packages as well.

```r
library(broom)

# Calculate leverage (hat values)
model_leverage <- hatvalues(model)

# Calculate standardized residuals
model_std_resid <- rstandard(model)

# Calculate Cook's distance
model_cooks_d <- cooks.distance(model)

# Create a dataframe for plotting
influence_data <- data.frame(
  Leverage = model_leverage,
  StdResiduals = model_std_resid,
  CooksDistance = model_cooks_d
)

# Generate the plot
ggplot(cbind(mat,influence_data), aes(x = Leverage, y = StdResiduals, size = CooksDistance)) +
  geom_point(alpha = 0.6) +
  scale_size_continuous(range = c(1, 12), guide = 'none') + # Adjust size scale and hide legend
  labs(title = "Influence Plot",
       subtitle = "Circle size is proportional to Cook's Distance",
       x = "Leverage",
       y = "Standardized Residuals") +
  theme_minimal()+
  facet_grid(sex~Type)
```

This script does the following:
- Calculates the leverage, standardized residuals, and Cook's distance for each observation in your logistic regression model.
- Constructs a dataframe `influence_data` that contains these values.
- Uses `ggplot2` to create a scatter plot where the x-axis is leverage, the y-axis is standardized residuals, and the size of each point represents Cook's distance.

Adjust the `scale_size_continuous` function as needed to better fit your data. The `guide = 'none'` argument hides the size legend since it generally clutters the plot. This approach gives you a detailed and customizable influence plot using `ggplot2`.

Creating an influence plot with `ggplot2` requires calculating influence measures like Cook's distance, leveraging the model you've fitted, and then plotting these measures. The influence plot visually identifies points that have a significant impact on the model's estimates. Here's how you can create an influence plot for your logistic regression model using `ggplot2` in R:

1. **Calculate Cook's Distance**: Cook's distance is a measure used to estimate the influence of each data point. In logistic regression, it identifies points that, if removed, would change the model's parameters significantly.

2. **Prepare the Data**: Combine the Cook's distance with your original dataset or create a new dataframe with the Cook's distance and leverage values for each observation.

3. **Plot Using `ggplot2`**: Create the plot using `ggplot2`, highlighting observations with high influence.

Here's an example code snippet that demonstrates this process:

### 4. Multicollinearity
- **Variance Inflation Factor (VIF)**: Check for multicollinearity among predictors.
```{r}
vif(model)
```

### 5. Model Assumptions and Fit
- **Check Linearity**: The logit link assumes a linear relationship between log odds and predictors. Use plots or Generalized Additive Models (GAMs) to assess this.
```{r}
library(mgcv)
gam_model = gam(mature ~ s(len) + sex + Type, family=binomial, data=mat)
plot(gam_model)
```

```{r}
# Load necessary libraries
library(mgcv)
library(ggplot2)

# Assuming your GAM model is named gam_model
gam_model <- gam(mature ~ s(len) + sex + Type, family=binomial(), data=mat)

# Extracting the smooth term for 'len'
smooth_len <- plot(gam_model, select = 1, se = TRUE)[[1]] # 'select=1' selects the first smooth term, usually it's s(len)

# Convert to a data frame for ggplot
df_smooth_len <- data.frame(
  len   =smooth_len$x,
  fitted=smooth_len$fit,
  lower =smooth_len$fit - 2 * smooth_len$se,
  upper =smooth_len$fit + 2 * smooth_len$se
)

# Plot using ggplot2
ggplot(df_smooth_len, aes(x = len)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = "lightblue", alpha = 0.5) +
  geom_line(aes(y = fitted), color = "blue") +
  labs(title = "Effect of Length on Maturity", x = "Length", y = "Estimated Effect") +
  theme_minimal()

```

- **Check for Overdispersion**: This is less of a concern in binary logistic regression but can be relevant for count data.

### 6. Predicted vs. Observed
- **Predicted vs. Observed**: Compare the predicted probabilities to the observed outcomes to evaluate the model's performance.

```{r,eval=FALSE}
fitted_probs = predict(model, type="response")
plot(pDogGonad$mature, fitted_probs, xlab="Observed", ylab="Predicted", main="Predicted vs Observed")
abline(0,1)
```

### Species
```{r species-count}
sort(unique(biol$Scientific_name))
```

